# Алгоритм базы знаний и каскадирования целей

## Назначение

Инструмент каскадирования целей по иерархии: от целей руководителей банка (председатель) к целям директоров департаментов. Данные хранятся в структурированном JSON, удобном для векторизации и использования LLM.

## Типы документов (коллекции)

| Тип | Описание |
|-----|----------|
| **Цели председателя банка** | Загружаются отдельно, прогоняются через LLM → JSON с целями, весами, квартальными значениями |
| **Чеклист по стратегии банка** | Преобразуется в JSON (разделы и пункты) |
| **Чеклист по регламенту банка** | Правила постановки целей → JSON |
| **Чеклист по целям департамента** | Помогает сформировать и каскадировать цели на директора департамента → JSON |
| **Чеклист по бизнес-плану** | Пункты чеклиста → JSON |
| **Таблица целей (форма)** | Итоговая форма КПЭ по шаблону; может быть получена с помощью LLM по приложенным документам |

## Алгоритм предобработки

1. **Загрузка**  
   Пользователь прикрепляет файл одного из типов (PDF, DOCX, XLSX, TXT) на вкладке «База знаний», выбирая тип документа.

2. **Сохранение**  
   Файл сохраняется на бэкенде в `uploads/{document_type}/{id}_{filename}`. Метаданные (id, имя, тип, путь) записываются в индекс `uploads/index.json`.

3. **Предобработка (по кнопке «Предобработать»)**  
   - Извлечение текста: из PDF (pypdf), DOCX (python-docx), XLSX (openpyxl), TXT — в один текст.  
   - Вызов локальной LLM (Open Web UI или OpenAI-совместимый endpoint) с системным промптом и промптом для данного типа документа.  
   - Промпт просит вернуть **только валидный JSON** заданной структуры (цели с id, title, weight, quarters; чеклисты — items/rules с id, text, section; таблица целей — rows с колонками по кварталам и году).  
   - Ответ парсится как JSON и сохраняется в индексе документа (`parsed_json`).  
   - Статус документа: `preprocessed: true`.

4. **Использование в каскадировании**  
   - В чате или сценарии каскадирования (LangGraph) используются уже подготовленные JSON: цели председателя, чеклисты стратегии/регламента/департамента/бизнес-плана.  
   - Модель получает структурированные данные (и при необходимости векторизованные фрагменты) и формирует KPI директора департамента и таблицу целей по шаблону (см. `data/prompt.txt`).

## Цепочка данных

```
Цели председателя (файл) → LLM → JSON целей с весами и кварталами
Чеклист стратегии       → LLM → JSON разделов и пунктов
Чеклист регламента      → LLM → JSON правил
Чеклист целей департамента → LLM → JSON целей и задач
Чеклист бизнес-плана   → LLM → JSON пунктов
                    ↓
        Векторизация / контекст для LLM
                    ↓
        Промпт каскадирования (data/prompt.txt)
                    ↓
        KPI директора + таблица целей (форма)
```

## Пример данных

- Входные примеры: `data/list_main_goals.txt`, `data/checklist_strategy.txt`, `data/checklist_reglament.txt`, `data/checklist_goals_credits.txt`, `data/checklist_business_plan.txt`, `data/lead_goals_template.csv`.
- Итоговый промпт для формирования KPI и таблицы: `data/prompt.txt`.

## Настройка LLM для предобработки

В бэкенде задаются переменные окружения (или `.env`):

- `OPEN_WEBUI_URL` — базовый URL Open Web UI (или другого OpenAI-совместимого API).
- `OPEN_WEBUI_API_KEY` — API-ключ.

Без них кнопка «Предобработать» вернёт ошибку; загрузка и список документов работают.
